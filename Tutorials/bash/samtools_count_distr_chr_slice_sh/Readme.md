Documentation to create a distributed applet can be found on the [Developer Tutorials wiki page](https://wiki.dnanexus.com/Developer-Tutorials/Parallelize-Your-App). This readme will focus on the details of this applet.

## How is SAMtools dependency provided?
SAMtools dependency is resolved by declaring an [Apt-Get](https://help.ubuntu.com/14.04/serverguide/apt-get.html) package in the dxapp.json runSpec.execDepends.
```json
{
...
    "runSpec": {
  	...
      "execDepends": [
        {"name": "samtools"}
      ]
    }
...
}
```
For additional information, please refer to the [execDepends wiki page](https://wiki.dnanexus.com/Execution-Environment-Reference#Software-Packages).

## Entry points
Distributed bash-interpreter apps use bash functions to [declare entry points](https://wiki.dnanexus.com/Developer-Tutorials/Parallelize-Your-App#Adding-Entry-Points-to-Your-Code). This app has the following entry points specified as bash functions:

* *main* 
* *count_func*
* *sum_reads*

Entry points are executed on a new worker with their own system requirements. Instance type can be set in the dxapp.json `runSpec.systemRequirements`:
```json
{
  "runSpec": {
    ...
    "systemRequirements": {
      "main": {
        "instanceType": "mem1_ssd1_x4"
      },
      "count_func": {
        "instanceType": "mem1_ssd1_x2"
      },
      "sum_reads": {
        "instanceType": "mem1_ssd1_x4"
      }
    },
    ...
  }
}
```
## Overview
### main
The *main* function slices the initial `*.bam`, generates an index `*.bai` if needed, into smaller `*.bam` files containing only reads from canonical chromosomes. First the main function downloads the BAM file and gets the headers.
<!-- SECTION: Downloading inputs and get chromosomes list from headers -->

Sliced `*.bam` files are uploaded and their file id is passed to the *count_func* entry point using [dx-jobutil-new-job](https://wiki.dnanexus.com/Helpstrings-of-SDK-Command-Line-Utilities#dx-jobutil-new-job) command.
<!-- SECTION: Split bam into multiple chromosomes and send as input to sam_count subjob -->


Outputs from the *count_func* entry points are referenced as Job Based Object References ([JBOR](https://wiki.dnanexus.com/API-Specification-v1.0.0/Job-Input-and-Output#Job-Dependencies)) and used as inputs for the *sum_reads* entry point.
<!-- SECTION: Gather output of count jobs and write to result file -->

Output of the *sum_reads* entry point is used as the output of the main entry point via JBOR reference in [dx-jobutil-add-output](https://wiki.dnanexus.com/Helpstrings-of-SDK-Command-Line-Utilities#dx-jobutil-add-output)
<!-- Upload chromosome_results.txt from sum_reads subjob as job output -->

### count_func
This entry point downloads and runs `samtools view -c` command on the sliced `*.bam`.  Generated counts_txt output is uploaded as the entry points job output via[dx-jobutil-add-output](https://wiki.dnanexus.com/Helpstrings-of-SDK-Command-Line-Utilities#dx-jobutil-add-output).
<!-- FUNCTION: count_func -->

### sum_reads
The *main* entry point triggers this sub job, providing the output of *count_func* as an input. This entry point gathers all the files generated by the *count_func* jobs and sums them.

returns read_sum_file as the entry point output.
<!-- FUNCTION: sum_reads -->
<!-- INCLUDE: ## Applet Script -->
<!-- FUNCTION: FULL SCRIPT -->